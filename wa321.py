# -*- coding: utf-8 -*-
"""wa321.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1h5aE8rbZCv_lflSjcAwiL4ppJoLsvods
"""

# âœ… â‘  å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆåˆå›ã®ã¿ï¼‰
import subprocess
subprocess.run(["pip", "install", "openai", "streamlit", "pyngrok"])
# âœ… â‘¡ OpenAI APIã‚­ãƒ¼ã®å…¥åŠ›ï¼ˆGPTã‚’ä½¿ã†ãŸã‚ï¼‰
import os
os.environ["OPENAI_API_KEY"] = input("ğŸ”‘ OpenAIã®APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„: ")
# âœ… â‘¢ Streamlitã‚¢ãƒ—ãƒªæœ¬ä½“ã®ã‚³ãƒ¼ãƒ‰ï¼ˆè¨€ã„è¨³ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼‰
app_code = '''
import streamlit as st
import openai
import os

openai.api_key = os.getenv("OPENAI_API_KEY")

st.title("ğŸ§  GPTè¨€ã„è¨³ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼")
st.write("çŠ¶æ³ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€GPTãŒè‡ªç„¶ãªè¨€ã„è¨³ã‚’è€ƒãˆã¾ã™ã€‚")

situation = st.text_area("â“ è¨€ã„è¨³ã—ãŸã„çŠ¶æ³ã¯ï¼Ÿ")
tone = st.selectbox("ğŸ—£ï¸ æ–‡ä½“ã¯ï¼Ÿ", ["æ•¬èª", "ã‚¿ãƒ¡å£", "ã©ã£ã¡ã§ã‚‚"])

if st.button("GPTã«ç›¸è«‡ï¼") and situation.strip():
    with st.spinner("è€ƒãˆä¸­â€¦"):
        prompt = f"""
ã‚ãªãŸã¯â€œè¨€ã„è¨³ã®ãƒ—ãƒ­â€ã§ã™ã€‚æ¬¡ã®çŠ¶æ³ã«è‡ªç„¶ã§ç´å¾—ã•ã‚Œã‚„ã™ã„è¨€ã„è¨³ã‚’è€ƒãˆã¦ãã ã•ã„ã€‚

çŠ¶æ³: {situation}
å¸Œæœ›ã®æ–‡ä½“: {tone}
"""
        response = openai.ChatCompletion.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.9,
            max_tokens=300,
        )
        st.success(response.choices[0].message.content.strip())
'''

# âœ… ä¿å­˜ï¼šä¸Šã®ã‚³ãƒ¼ãƒ‰ã‚’ app.py ã«æ›¸ãè¾¼ã‚€
with open("app.py", "w") as f:
    f.write(app_code)
# âœ… â‘£ ngrokã®ãƒˆãƒ¼ã‚¯ãƒ³ç™»éŒ²ï¼ˆç™»éŒ²æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—å¯èƒ½ï¼‰
subprocess.run([
    "ngrok", "config", "add-authtoken",
    "2ykVq3DmiAplWCK0dJTSM0ycZ6n_5z2CX2i7xPKWq1scb4Py4"  # â† ã‚ãªãŸã®ãƒˆãƒ¼ã‚¯ãƒ³ã«å¤‰æ›´
])
# âœ… â‘¤ ãƒˆãƒ³ãƒãƒ«ã‚’å¸¸ã«1ã¤ã«ä¿ã£ã¦å†æ¥ç¶š
from pyngrok import ngrok
ngrok.kill()  # âœ… å¤ã„ãƒˆãƒ³ãƒãƒ«å…¨ã¦çµ‚äº†ï¼ˆâ†ã“ã“ãŒè¶…é‡è¦ï¼ï¼‰

public_url = ngrok.connect(8501)
print("ğŸ”— ã“ã®URLã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã‚¢ãƒ—ãƒªãŒé–‹ãã¾ã™ï¼š", public_url)
# âœ… â‘¥ Streamlitã‚¢ãƒ—ãƒªã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•
subprocess.Popen(["streamlit", "run", "app.py"], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)